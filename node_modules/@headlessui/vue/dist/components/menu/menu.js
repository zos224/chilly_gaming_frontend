import{defineComponent as x,ref as M,provide as K,inject as L,onMounted as k,onUnmounted as N,computed as R,nextTick as y,watchEffect as j}from"vue";import{Features as C,render as T}from'../../utils/render.js';import{useId as P}from'../../hooks/use-id.js';import{Keys as d}from'../../keyboard.js';import{Focus as g,calculateActiveIndex as B}from'../../utils/calculate-active-index.js';import{dom as f}from'../../utils/dom.js';import{useTreeWalker as U}from'../../hooks/use-tree-walker.js';import{useOpenClosedProvider as $,State as O,useOpenClosed as V}from'../../internal/open-closed.js';import{match as H}from'../../utils/match.js';import{useResolveButtonType as Q}from'../../hooks/use-resolve-button-type.js';import{FocusableMode as _,isFocusableElement as q,sortByDomNode as W,Focus as E,focusFrom as J,restoreFocusIfNecessary as F}from'../../utils/focus-management.js';import{useOutsideClick as z}from'../../hooks/use-outside-click.js';var G=(l=>(l[l.Open=0]="Open",l[l.Closed=1]="Closed",l))(G||{}),X=(l=>(l[l.Pointer=0]="Pointer",l[l.Other=1]="Other",l))(X||{});function Y(o){requestAnimationFrame(()=>requestAnimationFrame(o))}let A=Symbol("MenuContext");function D(o){let S=L(A,null);if(S===null){let l=new Error(`<${o} /> is missing a parent <Menu /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(l,D),l}return S}let ve=x({name:"Menu",props:{as:{type:[Object,String],default:"template"}},setup(o,{slots:S,attrs:l}){let v=M(1),e=M(null),p=M(null),u=M([]),m=M(""),c=M(null),I=M(1);function i(r=a=>a){let a=c.value!==null?u.value[c.value]:null,n=W(r(u.value.slice()),b=>f(b.dataRef.domRef)),s=a?n.indexOf(a):null;return s===-1&&(s=null),{items:n,activeItemIndex:s}}let t={menuState:v,buttonRef:e,itemsRef:p,items:u,searchQuery:m,activeItemIndex:c,activationTrigger:I,closeMenu:()=>{v.value=1,c.value=null},openMenu:()=>v.value=0,goToItem(r,a,n){let s=i(),b=B(r===g.Specific?{focus:g.Specific,id:a}:{focus:r},{resolveItems:()=>s.items,resolveActiveIndex:()=>s.activeItemIndex,resolveId:h=>h.id,resolveDisabled:h=>h.dataRef.disabled});m.value="",c.value=b,I.value=n!=null?n:1,u.value=s.items},search(r){let n=m.value!==""?0:1;m.value+=r.toLowerCase();let b=(c.value!==null?u.value.slice(c.value+n).concat(u.value.slice(0,c.value+n)):u.value).find(w=>w.dataRef.textValue.startsWith(m.value)&&!w.dataRef.disabled),h=b?u.value.indexOf(b):-1;h===-1||h===c.value||(c.value=h,I.value=1)},clearSearch(){m.value=""},registerItem(r,a){let n=i(s=>[...s,{id:r,dataRef:a}]);u.value=n.items,c.value=n.activeItemIndex,I.value=1},unregisterItem(r){let a=i(n=>{let s=n.findIndex(b=>b.id===r);return s!==-1&&n.splice(s,1),n});u.value=a.items,c.value=a.activeItemIndex,I.value=1}};return z([e,p],(r,a)=>{var n;t.closeMenu(),q(a,_.Loose)||(r.preventDefault(),(n=f(e))==null||n.focus())},R(()=>v.value===0)),K(A,t),$(R(()=>H(v.value,{[0]:O.Open,[1]:O.Closed}))),()=>{let r={open:v.value===0,close:t.closeMenu};return T({ourProps:{},theirProps:o,slot:r,slots:S,attrs:l,name:"Menu"})}}}),Ie=x({name:"MenuButton",props:{disabled:{type:Boolean,default:!1},as:{type:[Object,String],default:"button"}},setup(o,{attrs:S,slots:l,expose:v}){let e=D("MenuButton"),p=`headlessui-menu-button-${P()}`;v({el:e.buttonRef,$el:e.buttonRef});function u(i){switch(i.key){case d.Space:case d.Enter:case d.ArrowDown:i.preventDefault(),i.stopPropagation(),e.openMenu(),y(()=>{var t;(t=f(e.itemsRef))==null||t.focus({preventScroll:!0}),e.goToItem(g.First)});break;case d.ArrowUp:i.preventDefault(),i.stopPropagation(),e.openMenu(),y(()=>{var t;(t=f(e.itemsRef))==null||t.focus({preventScroll:!0}),e.goToItem(g.Last)});break}}function m(i){switch(i.key){case d.Space:i.preventDefault();break}}function c(i){o.disabled||(e.menuState.value===0?(e.closeMenu(),y(()=>{var t;return(t=f(e.buttonRef))==null?void 0:t.focus({preventScroll:!0})})):(i.preventDefault(),e.openMenu(),Y(()=>{var t;return(t=f(e.itemsRef))==null?void 0:t.focus({preventScroll:!0})})))}let I=Q(R(()=>({as:o.as,type:S.type})),e.buttonRef);return()=>{var a;let i={open:e.menuState.value===0},t={ref:e.buttonRef,id:p,type:I.value,"aria-haspopup":!0,"aria-controls":(a=f(e.itemsRef))==null?void 0:a.id,"aria-expanded":o.disabled?void 0:e.menuState.value===0,onKeydown:u,onKeyup:m,onClick:c};return T({ourProps:t,theirProps:o,slot:i,attrs:S,slots:l,name:"MenuButton"})}}}),ge=x({name:"MenuItems",props:{as:{type:[Object,String],default:"div"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0}},setup(o,{attrs:S,slots:l,expose:v}){let e=D("MenuItems"),p=`headlessui-menu-items-${P()}`,u=M(null);v({el:e.itemsRef,$el:e.itemsRef}),U({container:R(()=>f(e.itemsRef)),enabled:R(()=>e.menuState.value===0),accept(t){return t.getAttribute("role")==="menuitem"?NodeFilter.FILTER_REJECT:t.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(t){t.setAttribute("role","none")}});function m(t){var r;switch(u.value&&clearTimeout(u.value),t.key){case d.Space:if(e.searchQuery.value!=="")return t.preventDefault(),t.stopPropagation(),e.search(t.key);case d.Enter:if(t.preventDefault(),t.stopPropagation(),e.activeItemIndex.value!==null){let n=e.items.value[e.activeItemIndex.value];(r=f(n.dataRef.domRef))==null||r.click()}e.closeMenu(),F(f(e.buttonRef));break;case d.ArrowDown:return t.preventDefault(),t.stopPropagation(),e.goToItem(g.Next);case d.ArrowUp:return t.preventDefault(),t.stopPropagation(),e.goToItem(g.Previous);case d.Home:case d.PageUp:return t.preventDefault(),t.stopPropagation(),e.goToItem(g.First);case d.End:case d.PageDown:return t.preventDefault(),t.stopPropagation(),e.goToItem(g.Last);case d.Escape:t.preventDefault(),t.stopPropagation(),e.closeMenu(),y(()=>{var a;return(a=f(e.buttonRef))==null?void 0:a.focus({preventScroll:!0})});break;case d.Tab:t.preventDefault(),t.stopPropagation(),e.closeMenu(),y(()=>J(f(e.buttonRef),t.shiftKey?E.Previous:E.Next));break;default:t.key.length===1&&(e.search(t.key),u.value=setTimeout(()=>e.clearSearch(),350));break}}function c(t){switch(t.key){case d.Space:t.preventDefault();break}}let I=V(),i=R(()=>I!==null?I.value===O.Open:e.menuState.value===0);return()=>{var n,s;let t={open:e.menuState.value===0},r={"aria-activedescendant":e.activeItemIndex.value===null||(n=e.items.value[e.activeItemIndex.value])==null?void 0:n.id,"aria-labelledby":(s=f(e.buttonRef))==null?void 0:s.id,id:p,onKeydown:m,onKeyup:c,role:"menu",tabIndex:0,ref:e.itemsRef};return T({ourProps:r,theirProps:o,slot:t,attrs:S,slots:l,features:C.RenderStrategy|C.Static,visible:i.value,name:"MenuItems"})}}}),Se=x({name:"MenuItem",props:{as:{type:[Object,String],default:"template"},disabled:{type:Boolean,default:!1}},setup(o,{slots:S,attrs:l,expose:v}){let e=D("MenuItem"),p=`headlessui-menu-item-${P()}`,u=M(null);v({el:u,$el:u});let m=R(()=>e.activeItemIndex.value!==null?e.items.value[e.activeItemIndex.value].id===p:!1),c=R(()=>({disabled:o.disabled,textValue:"",domRef:u}));k(()=>{var n,s;let a=(s=(n=f(u))==null?void 0:n.textContent)==null?void 0:s.toLowerCase().trim();a!==void 0&&(c.value.textValue=a)}),k(()=>e.registerItem(p,c)),N(()=>e.unregisterItem(p)),j(()=>{e.menuState.value===0&&(!m.value||e.activationTrigger.value!==0&&y(()=>{var a,n;return(n=(a=f(u))==null?void 0:a.scrollIntoView)==null?void 0:n.call(a,{block:"nearest"})}))});function I(a){if(o.disabled)return a.preventDefault();e.closeMenu(),F(f(e.buttonRef))}function i(){if(o.disabled)return e.goToItem(g.Nothing);e.goToItem(g.Specific,p)}function t(){o.disabled||m.value||e.goToItem(g.Specific,p,0)}function r(){o.disabled||!m.value||e.goToItem(g.Nothing)}return()=>{let{disabled:a}=o,n={active:m.value,disabled:a,close:e.closeMenu};return T({ourProps:{id:p,ref:u,role:"menuitem",tabIndex:a===!0?void 0:-1,"aria-disabled":a===!0?!0:void 0,onClick:I,onFocus:i,onPointermove:t,onMousemove:t,onPointerleave:r,onMouseleave:r},theirProps:o,slot:n,attrs:l,slots:S,name:"MenuItem"})}}});export{ve as Menu,Ie as MenuButton,Se as MenuItem,ge as MenuItems};
