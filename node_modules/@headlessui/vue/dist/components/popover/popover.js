import{Fragment as Q,computed as O,defineComponent as K,h as $,inject as _,provide as q,ref as T,watchEffect as U}from"vue";import{match as j}from'../../utils/match.js';import{render as G,omit as re,Features as N}from'../../utils/render.js';import{useId as k}from'../../hooks/use-id.js';import{Keys as w}from'../../keyboard.js';import{getFocusableElements as X,Focus as B,focusIn as L,isFocusableElement as le,FocusableMode as ae}from'../../utils/focus-management.js';import{dom as n}from'../../utils/dom.js';import{useOpenClosedProvider as ue,State as W,useOpenClosed as Y}from'../../internal/open-closed.js';import{useResolveButtonType as ie}from'../../hooks/use-resolve-button-type.js';import{useOutsideClick as se}from'../../hooks/use-outside-click.js';import{getOwnerDocument as A}from'../../utils/owner.js';import{useEventListener as pe}from'../../hooks/use-event-listener.js';import{Hidden as z,Features as J}from'../../internal/hidden.js';import{useTabDirection as Z,Direction as H}from'../../hooks/use-tab-direction.js';import'../../utils/micro-task.js';var fe=(v=>(v[v.Open=0]="Open",v[v.Closed=1]="Closed",v))(fe||{});let ee=Symbol("PopoverContext");function V(m){let S=_(ee,null);if(S===null){let v=new Error(`<${m} /> is missing a parent <${ce.name} /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(v,V),v}return S}let te=Symbol("PopoverGroupContext");function oe(){return _(te,null)}let ne=Symbol("PopoverPanelContext");function ve(){return _(ne,null)}let ce=K({name:"Popover",props:{as:{type:[Object,String],default:"div"}},setup(m,{slots:S,attrs:v,expose:E}){var p;let t=`headlessui-popover-button-${k()}`,e=`headlessui-popover-panel-${k()}`,b=T(null);E({el:b,$el:b});let u=T(1),d=T(null),g=T(null),y=T(null),s=T(null),c=O(()=>A(b)),h=O(()=>{var R,C;if(!n(d)||!n(s))return!1;for(let D of document.querySelectorAll("body > *"))if(Number(D==null?void 0:D.contains(n(d)))^Number(D==null?void 0:D.contains(n(s))))return!0;let r=X(),a=r.indexOf(n(d)),f=(a+r.length-1)%r.length,F=(a+1)%r.length,M=r[f],x=r[F];return!((R=n(s))!=null&&R.contains(M))&&!((C=n(s))!=null&&C.contains(x))}),P={popoverState:u,buttonId:t,panelId:e,panel:s,button:d,isPortalled:h,beforePanelSentinel:g,afterPanelSentinel:y,togglePopover(){u.value=j(u.value,{[0]:1,[1]:0})},closePopover(){u.value!==1&&(u.value=1)},close(r){P.closePopover();let a=(()=>r?r instanceof HTMLElement?r:r.value instanceof HTMLElement?n(r):n(P.button):n(P.button))();a==null||a.focus()}};q(ee,P),ue(O(()=>j(u.value,{[0]:W.Open,[1]:W.Closed})));let I={buttonId:t,panelId:e,close(){P.closePopover()}},l=oe(),o=l==null?void 0:l.registerPopover;function i(){var r,a,f,F;return(F=l==null?void 0:l.isFocusWithinPopoverGroup())!=null?F:((r=c.value)==null?void 0:r.activeElement)&&(((a=n(d))==null?void 0:a.contains(c.value.activeElement))||((f=n(s))==null?void 0:f.contains(c.value.activeElement)))}return U(()=>o==null?void 0:o(I)),pe((p=c.value)==null?void 0:p.defaultView,"focus",r=>{var a,f;u.value===0&&(i()||!d||!s||(a=n(P.beforePanelSentinel))!=null&&a.contains(r.target)||(f=n(P.afterPanelSentinel))!=null&&f.contains(r.target)||P.closePopover())},!0),se([d,s],(r,a)=>{var f;P.closePopover(),le(a,ae.Loose)||(r.preventDefault(),(f=n(d))==null||f.focus())},O(()=>u.value===0)),()=>{let r={open:u.value===0,close:P.close};return G({theirProps:m,ourProps:{ref:b},slot:r,slots:S,attrs:v,name:"Popover"})}}}),ke=K({name:"PopoverButton",props:{as:{type:[Object,String],default:"button"},disabled:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(m,{attrs:S,slots:v,expose:E}){let t=V("PopoverButton"),e=O(()=>A(t.button));E({el:t.button,$el:t.button});let b=oe(),u=b==null?void 0:b.closeOthers,d=ve(),g=d===null?!1:d===t.panelId,y=T(null),s=`headlessui-focus-sentinel-${k()}`;g||U(()=>{t.button.value=y.value});let c=ie(O(()=>({as:m.as,type:S.type})),y);function h(o){var i,p,r,a,f;if(g){if(t.popoverState.value===1)return;switch(o.key){case w.Space:case w.Enter:o.preventDefault(),(p=(i=o.target).click)==null||p.call(i),t.closePopover(),(r=n(t.button))==null||r.focus();break}}else switch(o.key){case w.Space:case w.Enter:o.preventDefault(),o.stopPropagation(),t.popoverState.value===1&&(u==null||u(t.buttonId)),t.togglePopover();break;case w.Escape:if(t.popoverState.value!==0)return u==null?void 0:u(t.buttonId);if(!n(t.button)||((a=e.value)==null?void 0:a.activeElement)&&!((f=n(t.button))!=null&&f.contains(e.value.activeElement)))return;o.preventDefault(),o.stopPropagation(),t.closePopover();break}}function P(o){g||o.key===w.Space&&o.preventDefault()}function I(o){var i,p;m.disabled||(g?(t.closePopover(),(i=n(t.button))==null||i.focus()):(o.preventDefault(),o.stopPropagation(),t.popoverState.value===1&&(u==null||u(t.buttonId)),t.togglePopover(),(p=n(t.button))==null||p.focus()))}function l(o){o.preventDefault(),o.stopPropagation()}return()=>{let o=t.popoverState.value===0,i={open:o},p=g?{ref:y,type:c.value,onKeydown:h,onClick:I}:{ref:y,id:t.buttonId,type:c.value,"aria-expanded":m.disabled?void 0:t.popoverState.value===0,"aria-controls":n(t.panel)?t.panelId:void 0,disabled:m.disabled?!0:void 0,onKeydown:h,onKeyup:P,onClick:I,onMousedown:l},r=Z();function a(){let f=n(t.panel);if(!f)return;function F(){j(r.value,{[H.Forwards]:()=>L(f,B.First),[H.Backwards]:()=>L(f,B.Last)})}F()}return $(Q,[G({ourProps:p,theirProps:{...S,...m},slot:i,attrs:S,slots:v,name:"PopoverButton"}),o&&!g&&t.isPortalled.value&&$(z,{id:s,features:J.Focusable,as:"button",type:"button",onFocus:a})])}}}),Be=K({name:"PopoverOverlay",props:{as:{type:[Object,String],default:"div"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0}},setup(m,{attrs:S,slots:v}){let E=V("PopoverOverlay"),t=`headlessui-popover-overlay-${k()}`,e=Y(),b=O(()=>e!==null?e.value===W.Open:E.popoverState.value===0);function u(){E.closePopover()}return()=>{let d={open:E.popoverState.value===0};return G({ourProps:{id:t,"aria-hidden":!0,onClick:u},theirProps:m,slot:d,attrs:S,slots:v,features:N.RenderStrategy|N.Static,visible:b.value,name:"PopoverOverlay"})}}}),Le=K({name:"PopoverPanel",props:{as:{type:[Object,String],default:"div"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},focus:{type:Boolean,default:!1}},inheritAttrs:!1,setup(m,{attrs:S,slots:v,expose:E}){let{focus:t}=m,e=V("PopoverPanel"),b=O(()=>A(e.panel)),u=`headlessui-focus-sentinel-before-${k()}`,d=`headlessui-focus-sentinel-after-${k()}`;E({el:e.panel,$el:e.panel}),q(ne,e.panelId),U(()=>{var o,i;if(!t||e.popoverState.value!==0||!e.panel)return;let l=(o=b.value)==null?void 0:o.activeElement;(i=n(e.panel))!=null&&i.contains(l)||L(n(e.panel),B.First)});let g=Y(),y=O(()=>g!==null?g.value===W.Open:e.popoverState.value===0);function s(l){var o,i;switch(l.key){case w.Escape:if(e.popoverState.value!==0||!n(e.panel)||b.value&&!((o=n(e.panel))!=null&&o.contains(b.value.activeElement)))return;l.preventDefault(),l.stopPropagation(),e.closePopover(),(i=n(e.button))==null||i.focus();break}}function c(l){var i,p,r,a,f;let o=l.relatedTarget;!o||!n(e.panel)||(i=n(e.panel))!=null&&i.contains(o)||(e.closePopover(),(((r=(p=n(e.beforePanelSentinel))==null?void 0:p.contains)==null?void 0:r.call(p,o))||((f=(a=n(e.afterPanelSentinel))==null?void 0:a.contains)==null?void 0:f.call(a,o)))&&o.focus({preventScroll:!0}))}let h=Z();function P(){let l=n(e.panel);if(!l)return;function o(){j(h.value,{[H.Forwards]:()=>{L(l,B.Next)},[H.Backwards]:()=>{var i;(i=n(e.button))==null||i.focus({preventScroll:!0})}})}o()}function I(){let l=n(e.panel);if(!l)return;function o(){j(h.value,{[H.Forwards]:()=>{var x,R;let i=n(e.button),p=n(e.panel);if(!i)return;let r=X(),a=r.indexOf(i),f=r.slice(0,a+1),M=[...r.slice(a+1),...f];for(let C of M.slice())if(((R=(x=C==null?void 0:C.id)==null?void 0:x.startsWith)==null?void 0:R.call(x,"headlessui-focus-sentinel-"))||(p==null?void 0:p.contains(C))){let D=M.indexOf(C);D!==-1&&M.splice(D,1)}L(M,B.First,!1)},[H.Backwards]:()=>L(l,B.Previous)})}o()}return()=>{let l={open:e.popoverState.value===0,close:e.close},o={ref:e.panel,id:e.panelId,onKeydown:s,onFocusout:t&&e.popoverState.value===0?c:void 0,tabIndex:-1};return G({ourProps:o,theirProps:{...S,...re(m,["focus"])},attrs:S,slot:l,slots:{...v,default:(...i)=>{var p;return[$(Q,[y.value&&e.isPortalled.value&&$(z,{id:u,ref:e.beforePanelSentinel,features:J.Focusable,as:"button",type:"button",onFocus:P}),(p=v.default)==null?void 0:p.call(v,...i),y.value&&e.isPortalled.value&&$(z,{id:d,ref:e.afterPanelSentinel,features:J.Focusable,as:"button",type:"button",onFocus:I})])]}},features:N.RenderStrategy|N.Static,visible:y.value,name:"PopoverPanel"})}}}),He=K({name:"PopoverGroup",props:{as:{type:[Object,String],default:"div"}},setup(m,{attrs:S,slots:v,expose:E}){let t=T(null),e=T([]),b=O(()=>A(t));E({el:t,$el:t});function u(s){let c=e.value.indexOf(s);c!==-1&&e.value.splice(c,1)}function d(s){return e.value.push(s),()=>{u(s)}}function g(){var h;let s=b.value;if(!s)return!1;let c=s.activeElement;return(h=n(t))!=null&&h.contains(c)?!0:e.value.some(P=>{var I,l;return((I=s.getElementById(P.buttonId))==null?void 0:I.contains(c))||((l=s.getElementById(P.panelId))==null?void 0:l.contains(c))})}function y(s){for(let c of e.value)c.buttonId!==s&&c.close()}return q(te,{registerPopover:d,unregisterPopover:u,isFocusWithinPopoverGroup:g,closeOthers:y}),()=>G({ourProps:{ref:t},theirProps:m,slot:{},attrs:S,slots:v,name:"PopoverGroup"})}});export{ce as Popover,ke as PopoverButton,He as PopoverGroup,Be as PopoverOverlay,Le as PopoverPanel};
