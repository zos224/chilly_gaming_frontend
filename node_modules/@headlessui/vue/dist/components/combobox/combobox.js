import{Fragment as G,computed as R,defineComponent as A,h as U,inject as Q,nextTick as V,onMounted as W,onUnmounted as X,provide as Y,ref as T,toRaw as b,watch as q,watchEffect as K}from"vue";import{Features as H,render as F,omit as $,compact as Z}from'../../utils/render.js';import{useId as N}from'../../hooks/use-id.js';import{Keys as P}from'../../keyboard.js';import{calculateActiveIndex as z,Focus as w}from'../../utils/calculate-active-index.js';import{dom as h}from'../../utils/dom.js';import{useOpenClosed as ee,State as _,useOpenClosedProvider as te}from'../../internal/open-closed.js';import{match as M}from'../../utils/match.js';import{useResolveButtonType as oe}from'../../hooks/use-resolve-button-type.js';import{useTreeWalker as ne}from'../../hooks/use-tree-walker.js';import{sortByDomNode as ae}from'../../utils/focus-management.js';import{useOutsideClick as le}from'../../hooks/use-outside-click.js';import{Hidden as ie,Features as ue}from'../../internal/hidden.js';import{objectToFormEntries as re}from'../../utils/form.js';import{useControllable as se}from'../../hooks/use-controllable.js';function de(o,m){return o===m}var pe=(d=>(d[d.Open=0]="Open",d[d.Closed=1]="Closed",d))(pe||{}),be=(d=>(d[d.Single=0]="Single",d[d.Multi=1]="Multi",d))(be||{}),fe=(d=>(d[d.Pointer=0]="Pointer",d[d.Other=1]="Other",d))(fe||{});let J=Symbol("ComboboxContext");function L(o){let m=Q(J,null);if(m===null){let d=new Error(`<${o} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(d,L),d}return m}let Ae=A({name:"Combobox",emits:{"update:modelValue":o=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},by:{type:[String,Function],default:()=>de},modelValue:{type:[Object,String,Number,Boolean],default:void 0},defaultValue:{type:[Object,String,Number,Boolean],default:void 0},name:{type:String},nullable:{type:Boolean,default:!1},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(o,{slots:m,attrs:d,emit:I}){let e=T(1),t=T(null),v=T(null),g=T(null),x=T(null),c=T({static:!1,hold:!1}),a=T([]),C=T(null),O=T(1),y=T(!1);function f(n=i=>i){let i=C.value!==null?a.value[C.value]:null,s=ae(n(a.value.slice()),p=>h(p.dataRef.domRef)),u=i?s.indexOf(i):null;return u===-1&&(u=null),{options:s,activeOptionIndex:u}}let D=R(()=>o.multiple?1:0),B=R(()=>o.nullable),[E,l]=se(R(()=>o.modelValue),n=>I("update:modelValue",n),R(()=>o.defaultValue)),r={comboboxState:e,value:E,mode:D,compare(n,i){if(typeof o.by=="string"){let s=o.by;return(n==null?void 0:n[s])===(i==null?void 0:i[s])}return o.by(n,i)},nullable:B,inputRef:v,labelRef:t,buttonRef:g,optionsRef:x,disabled:R(()=>o.disabled),options:a,change(n){l(n)},activeOptionIndex:R(()=>{if(y.value&&C.value===null&&a.value.length>0){let n=a.value.findIndex(i=>!i.dataRef.disabled);if(n!==-1)return n}return C.value}),activationTrigger:O,optionsPropsRef:c,closeCombobox(){y.value=!1,!o.disabled&&e.value!==1&&(e.value=1,C.value=null)},openCombobox(){if(y.value=!0,o.disabled||e.value===0)return;let n=a.value.findIndex(i=>{let s=b(i.dataRef.value);return M(D.value,{[0]:()=>r.compare(b(r.value.value),b(s)),[1]:()=>b(r.value.value).some(p=>r.compare(b(p),b(s)))})});n!==-1&&(C.value=n),e.value=0},goToOption(n,i,s){if(y.value=!1,o.disabled||x.value&&!c.value.static&&e.value===1)return;let u=f();if(u.activeOptionIndex===null){let S=u.options.findIndex(j=>!j.dataRef.disabled);S!==-1&&(u.activeOptionIndex=S)}let p=z(n===w.Specific?{focus:w.Specific,id:i}:{focus:n},{resolveItems:()=>u.options,resolveActiveIndex:()=>u.activeOptionIndex,resolveId:S=>S.id,resolveDisabled:S=>S.dataRef.disabled});C.value=p,O.value=s!=null?s:1,a.value=u.options},selectOption(n){let i=a.value.find(u=>u.id===n);if(!i)return;let{dataRef:s}=i;l(M(D.value,{[0]:()=>s.value,[1]:()=>{let u=b(r.value.value).slice(),p=b(s.value),S=u.findIndex(j=>r.compare(p,b(j)));return S===-1?u.push(p):u.splice(S,1),u}}))},selectActiveOption(){if(r.activeOptionIndex.value===null)return;let{dataRef:n,id:i}=a.value[r.activeOptionIndex.value];l(M(D.value,{[0]:()=>n.value,[1]:()=>{let s=b(r.value.value).slice(),u=b(n.value),p=s.findIndex(S=>r.compare(u,b(S)));return p===-1?s.push(u):s.splice(p,1),s}})),r.goToOption(w.Specific,i)},registerOption(n,i){let s={id:n,dataRef:i},u=f(p=>[...p,s]);if(C.value===null){let p=i.value.value;M(D.value,{[0]:()=>r.compare(b(r.value.value),b(p)),[1]:()=>b(r.value.value).some(j=>r.compare(b(j),b(p)))})&&(u.activeOptionIndex=u.options.indexOf(s))}a.value=u.options,C.value=u.activeOptionIndex,O.value=1},unregisterOption(n){let i=f(s=>{let u=s.findIndex(p=>p.id===n);return u!==-1&&s.splice(u,1),s});a.value=i.options,C.value=i.activeOptionIndex,O.value=1}};le([v,g,x],()=>r.closeCombobox(),R(()=>e.value===0)),Y(J,r),te(R(()=>M(e.value,{[0]:_.Open,[1]:_.Closed})));let k=R(()=>r.activeOptionIndex.value===null?null:a.value[r.activeOptionIndex.value].dataRef.value);return()=>{let{name:n,disabled:i,...s}=o,u={open:e.value===0,disabled:i,activeIndex:r.activeOptionIndex.value,activeOption:k.value,value:E.value};return U(G,[...n!=null&&E.value!=null?re({[n]:E.value}).map(([p,S])=>U(ie,Z({features:ue.Hidden,key:p,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:p,value:S}))):[],F({theirProps:{...d,...$(s,["modelValue","defaultValue","nullable","multiple","onUpdate:modelValue","by"])},ourProps:{},slot:u,slots:m,attrs:d,name:"Combobox"})])}}}),Fe=A({name:"ComboboxLabel",props:{as:{type:[Object,String],default:"label"}},setup(o,{attrs:m,slots:d}){let I=L("ComboboxLabel"),e=`headlessui-combobox-label-${N()}`;function t(){var v;(v=h(I.inputRef))==null||v.focus({preventScroll:!0})}return()=>{let v={open:I.comboboxState.value===0,disabled:I.disabled.value},g={id:e,ref:I.labelRef,onClick:t};return F({ourProps:g,theirProps:o,slot:v,attrs:m,slots:d,name:"ComboboxLabel"})}}}),Le=A({name:"ComboboxButton",props:{as:{type:[Object,String],default:"button"}},setup(o,{attrs:m,slots:d,expose:I}){let e=L("ComboboxButton"),t=`headlessui-combobox-button-${N()}`;I({el:e.buttonRef,$el:e.buttonRef});function v(c){e.disabled.value||(e.comboboxState.value===0?e.closeCombobox():(c.preventDefault(),e.openCombobox()),V(()=>{var a;return(a=h(e.inputRef))==null?void 0:a.focus({preventScroll:!0})}))}function g(c){switch(c.key){case P.ArrowDown:c.preventDefault(),c.stopPropagation(),e.comboboxState.value===1&&e.openCombobox(),V(()=>{var a;return(a=e.inputRef.value)==null?void 0:a.focus({preventScroll:!0})});return;case P.ArrowUp:c.preventDefault(),c.stopPropagation(),e.comboboxState.value===1&&(e.openCombobox(),V(()=>{e.value.value||e.goToOption(w.Last)})),V(()=>{var a;return(a=e.inputRef.value)==null?void 0:a.focus({preventScroll:!0})});return;case P.Escape:if(e.comboboxState.value!==0)return;c.preventDefault(),e.optionsRef.value&&!e.optionsPropsRef.value.static&&c.stopPropagation(),e.closeCombobox(),V(()=>{var a;return(a=e.inputRef.value)==null?void 0:a.focus({preventScroll:!0})});return}}let x=oe(R(()=>({as:o.as,type:m.type})),e.buttonRef);return()=>{var O,y;let c={open:e.comboboxState.value===0,disabled:e.disabled.value,value:e.value.value},a={ref:e.buttonRef,id:t,type:x.value,tabindex:"-1","aria-haspopup":!0,"aria-controls":(O=h(e.optionsRef))==null?void 0:O.id,"aria-expanded":e.disabled.value?void 0:e.comboboxState.value===0,"aria-labelledby":e.labelRef.value?[(y=h(e.labelRef))==null?void 0:y.id,t].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:g,onClick:v};return F({ourProps:a,theirProps:o,slot:c,attrs:m,slots:d,name:"ComboboxButton"})}}}),Be=A({name:"ComboboxInput",props:{as:{type:[Object,String],default:"input"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},displayValue:{type:Function}},emits:{change:o=>!0},setup(o,{emit:m,attrs:d,slots:I,expose:e}){let t=L("ComboboxInput"),v=`headlessui-combobox-input-${N()}`;e({el:t.inputRef,$el:t.inputRef});let g=T(t.value.value),x=()=>{var r;let l=t.value.value;return h(t.inputRef)?typeof o.displayValue!="undefined"?(r=o.displayValue(l))!=null?r:"":typeof l=="string"?l:"":""},c=T(""),a=!1;function C(l){let r=h(t.inputRef);!r||(r.value=l,a=!0,r.dispatchEvent(new Event("input",{bubbles:!0})),a=!1)}W(()=>{q([t.value,c],()=>{g.value=x()},{flush:"sync",immediate:!0}),q([g,t.comboboxState],([l,r],[k,n])=>{let i=h(t.inputRef);!i||(n===0&&r===1?C(l):l!==k&&(i.value=l))},{immediate:!0})});let O=T(!1);function y(){O.value=!0}function f(){setTimeout(()=>{O.value=!1})}function D(l){switch(l.key){case P.Backspace:case P.Delete:if(t.mode.value!==0||!t.nullable.value)return;let r=l.currentTarget;requestAnimationFrame(()=>{if(r.value===""){t.change(null);let k=h(t.optionsRef);k&&(k.scrollTop=0),t.goToOption(w.Nothing)}});break;case P.Enter:if(t.comboboxState.value!==0||O.value)return;if(l.preventDefault(),l.stopPropagation(),t.activeOptionIndex.value===null){t.closeCombobox();return}t.selectActiveOption(),t.mode.value===0&&t.closeCombobox();break;case P.ArrowDown:return l.preventDefault(),l.stopPropagation(),M(t.comboboxState.value,{[0]:()=>t.goToOption(w.Next),[1]:()=>t.openCombobox()});case P.ArrowUp:return l.preventDefault(),l.stopPropagation(),M(t.comboboxState.value,{[0]:()=>t.goToOption(w.Previous),[1]:()=>{t.openCombobox(),V(()=>{t.value.value||t.goToOption(w.Last)})}});case P.Home:case P.PageUp:return l.preventDefault(),l.stopPropagation(),t.goToOption(w.First);case P.End:case P.PageDown:return l.preventDefault(),l.stopPropagation(),t.goToOption(w.Last);case P.Escape:if(t.comboboxState.value!==0)return;l.preventDefault(),t.optionsRef.value&&!t.optionsPropsRef.value.static&&l.stopPropagation(),t.closeCombobox();break;case P.Tab:if(t.comboboxState.value!==0)return;t.mode.value===0&&t.selectActiveOption(),t.closeCombobox();break}}function B(l){m("change",l)}function E(l){a||t.openCombobox(),m("change",l)}return()=>{var n,i,s,u,p,S;let l={open:t.comboboxState.value===0},r={"aria-controls":(n=t.optionsRef.value)==null?void 0:n.id,"aria-expanded":t.disabled.value?void 0:t.comboboxState.value===0,"aria-activedescendant":t.activeOptionIndex.value===null||(i=t.options.value[t.activeOptionIndex.value])==null?void 0:i.id,"aria-multiselectable":t.mode.value===1?!0:void 0,"aria-labelledby":(p=(s=h(t.labelRef))==null?void 0:s.id)!=null?p:(u=h(t.buttonRef))==null?void 0:u.id,id:v,onCompositionstart:y,onCompositionend:f,onKeydown:D,onChange:B,onInput:E,role:"combobox",type:(S=d.type)!=null?S:"text",tabIndex:0,ref:t.inputRef},k=$(o,["displayValue"]);return F({ourProps:r,theirProps:k,slot:l,attrs:d,slots:I,features:H.RenderStrategy|H.Static,name:"ComboboxInput"})}}}),je=A({name:"ComboboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},hold:{type:[Boolean],default:!1}},setup(o,{attrs:m,slots:d,expose:I}){let e=L("ComboboxOptions"),t=`headlessui-combobox-options-${N()}`;I({el:e.optionsRef,$el:e.optionsRef}),K(()=>{e.optionsPropsRef.value.static=o.static}),K(()=>{e.optionsPropsRef.value.hold=o.hold});let v=ee(),g=R(()=>v!==null?v.value===_.Open:e.comboboxState.value===0);return ne({container:R(()=>h(e.optionsRef)),enabled:R(()=>e.comboboxState.value===0),accept(x){return x.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:x.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(x){x.setAttribute("role","none")}}),()=>{var C,O,y,f;let x={open:e.comboboxState.value===0},c={"aria-activedescendant":e.activeOptionIndex.value===null||(C=e.options.value[e.activeOptionIndex.value])==null?void 0:C.id,"aria-labelledby":(f=(O=h(e.labelRef))==null?void 0:O.id)!=null?f:(y=h(e.buttonRef))==null?void 0:y.id,id:t,ref:e.optionsRef,role:"listbox"},a=$(o,["hold"]);return F({ourProps:c,theirProps:a,slot:x,attrs:m,slots:d,features:H.RenderStrategy|H.Static,visible:g.value,name:"ComboboxOptions"})}}}),Ne=A({name:"ComboboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(o,{slots:m,attrs:d,expose:I}){let e=L("ComboboxOption"),t=`headlessui-combobox-option-${N()}`,v=T(null);I({el:v,$el:v});let g=R(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t:!1),x=R(()=>M(e.mode.value,{[0]:()=>e.compare(b(e.value.value),b(o.value)),[1]:()=>b(e.value.value).some(f=>e.compare(b(f),b(o.value)))})),c=R(()=>({disabled:o.disabled,value:o.value,domRef:v}));W(()=>e.registerOption(t,c)),X(()=>e.unregisterOption(t)),K(()=>{e.comboboxState.value===0&&(!g.value||e.activationTrigger.value!==0&&V(()=>{var f,D;return(D=(f=h(v))==null?void 0:f.scrollIntoView)==null?void 0:D.call(f,{block:"nearest"})}))});function a(f){if(o.disabled)return f.preventDefault();e.selectOption(t),e.mode.value===0&&e.closeCombobox()}function C(){if(o.disabled)return e.goToOption(w.Nothing);e.goToOption(w.Specific,t)}function O(){o.disabled||g.value||e.goToOption(w.Specific,t,0)}function y(){o.disabled||!g.value||e.optionsPropsRef.value.hold||e.goToOption(w.Nothing)}return()=>{let{disabled:f}=o,D={active:g.value,selected:x.value,disabled:f},B={id:t,ref:v,role:"option",tabIndex:f===!0?void 0:-1,"aria-disabled":f===!0?!0:void 0,"aria-selected":x.value,disabled:void 0,onClick:a,onFocus:C,onPointermove:O,onMousemove:O,onPointerleave:y,onMouseleave:y};return F({ourProps:B,theirProps:o,slot:D,attrs:d,slots:m,name:"ComboboxOption"})}}});export{Ae as Combobox,Le as ComboboxButton,Be as ComboboxInput,Fe as ComboboxLabel,Ne as ComboboxOption,je as ComboboxOptions};
